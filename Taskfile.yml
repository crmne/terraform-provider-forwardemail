# https://taskfile.dev
version: "3"
tasks:
  default:
    desc: "Help menu"
    cmds:
      - task --list

  build:
    desc: "Build the provider binary"
    cmds:
      - go build -v ./...
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - terraform-provider-forwardemail

  test:
    desc: "Run acceptance tests against the provider"
    env:
      TF_ACC: "true"
    cmds:
      - go mod tidy
      - go test ./forwardemail/... -v -timeout=30m
      - task: sweep

  install-tools:
    desc: "Install required tools"
    cmds:
      - go install github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@v0.22.0
      - go install github.com/goreleaser/goreleaser/v2@latest
      - go install github.com/bflad/tfproviderlint/cmd/tfproviderlint@latest
    status:
      - which tfplugindocs
      - which goreleaser
      - which tfproviderlint

  docs:
    desc: "Update the docs generated from description fields"
    deps:
      - install-tools
    cmds:
      - cd tools; go generate ./...
      - sed -i.bak 's/forwardemail Provider/Forward Email Provider/g' docs/index.md && rm docs/index.md.bak
    sources:
      - "forwardemail/**/*.go"
      - "main.go"
      - "examples/**/*.tf"
      - "examples/**/*.sh"
    generates:
      - docs/**/*.md

  fmt:
    desc: "Run gofumpt against the provider"
    cmds:
      - gofumpt -w .

  lint:
    desc: "Run linters against the provider"
    deps:
      - install-tools
    cmds:
      - golangci-lint run
      - tfproviderlint -R018=false ./...
      - cmd: |
          BADFMT=$(gofmt -s -l .)
          test -z "$BADFMT" || (echo -e "Invalid gofmt:\n$BADFMT"; exit 1)
        silent: true
      - go vet ./...

  install:
    desc: "Set up an override allowing a local version of the provider to be used"
    cmds:
      - cmd: |-
          cat <<EOF > "$HOME/.terraformrc"
          provider_installation {
            dev_overrides {
              "forwardemail/forwardemail" = "$GOPATH/bin"
            }
            direct {}
          }
          EOF
        silent: true
      - go install .

  uninstall:
    desc: "Remove any local overrides for local development"
    cmds:
      - rm -f "$HOME/.terraformrc"

  sweep:
    desc: "Run sweeper tests to clean up resources. WARNING: This will destroy resources! Use with caution."
    cmds:
      - go test ./forwardemail -v -timeout 5m -sweep=lab

  prep:
    desc: "Prepare the provider"
    deps:
      - fmt
      - lint
      - docs
      - install
    cmds:
      - go mod tidy

